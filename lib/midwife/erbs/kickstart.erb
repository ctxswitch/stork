# kickstart.erb
###############################################################################
### Kickstart generated by midwife
###############################################################################
install
reboot
text

###############################################################################
### Misc
###############################################################################
rootpw --iscrypted <%= random_password %>

###############################################################################
### Partitioning
###############################################################################
<%= partitions.emit %>

###############################################################################
### Networking
###############################################################################
<% interfaces.each do |iface| %>
<%= iface.emit %>
<% end %>
firewall --disabled

###############################################################################
### Environment
###############################################################################
lang en_US
langsupport --default=en_US
timezone <% timezone %>

###############################################################################
### SELinux
###############################################################################
selinux --disabled

###############################################################################
### Packages
###############################################################################
%packages 
@core
curl
openssh-clients
openssh-server
finger
pciutils
yum
at
acpid
vixie-cron
cronie-noanacron
crontabs
logrotate
ntp
ntpdate
tmpwatch
rsync
mailx
which
wget
man

###############################################################################
### Post
###############################################################################
%post --log=/root/midwife-post.log
chvt 3
echo "Executing post installation"
echo "Contacting midwife to notify of a successful install"
/usr/bin/curl http://<%= Midwife.configuration.server %>:9293/notify/<%= name %>/installed


echo
echo "Synchronizing clock"
ntpdate bigben.ibest.uidaho.edu

echo
echo "Setting up chef"
cd /tmp
curl -L https://www.opscode.com/chef/install.sh > install.sh
chmod 700 install.sh

./install.sh -v <%= Midwife.configuration.chef_version %>

mkdir -p /etc/chef

touch /etc/chef/validation.pem
chmod 0644 /etc/chef/validation.pem

cat > /etc/chef/validation.pem << 'EOF'
<%= Midwife.configuration.chef_validation_key %>
EOF

echo
echo "Adding client.rb"
touch /etc/chef/client.rb
chmod 644 /etc/chef/client.rb
cat > /etc/chef/client.rb << 'EOF'
log_level              :auto
log_location           STDOUT
chef_server_url        '<%= Midwife.configuration.chef_server_url %>'
validation_client_name '<%= Midwife.configuration.chef_validator %>'
EOF

echo
echo "Setting up .chef"
mkdir /root/.chef
chmod 700 /root/.chef

echo
echo "Setting up knife.rb"
touch /root/.chef/knife.rb
chmod 600 /root/.chef/knife.rb
cat > /root/.chef/knife.rb << 'EOF'
log_level                :info
log_location             STDOUT
node_name                '<%= Midwife.configuration.chef_client_name %>'
client_key               '/root/.chef/<%= Midwife.configuration.chef_client_name %>.pem'
validation_client_name   '<%= Midwife.configuration.chef_validator %>'
validation_key           '/etc/chef/validation.pem'
chef_server_url          '<%= Midwife.configuration.chef_server_url %>'
cache_type               'BasicFile'
cache_options( :path => '/root/.chef/checksums' )
EOF

echo
echo "Setting up <%= Midwife.configuration.chef_client_name %>.pem"
touch /root/.chef/<%= Midwife.configuration.chef_client_name %>.pem
chmod 600 /root/.chef/<%= Midwife.configuration.chef_client_name %>.pem
cat > /root/.chef/<%= Midwife.configuration.chef_client_name %>.pem << 'EOF'
<%= Midwife.configuration.chef_client_key %>
EOF

echo
echo "Reregistering client"
knife client reregister <%= name %> -f /etc/chef/client.pem --config /root/.chef/knife.rb

echo
echo "Setting up chef first boot"
touch /etc/chef/first-boot.json
chmod 644 /etc/chef/first-boot.json
curl http://<%= Midwife.configuration.server %>/runlist/<%= name %> > /etc/chef/first-boot.json
/usr/bin/chef-client -j /etc/chef/first-boot.json
chkconfig chef-client on