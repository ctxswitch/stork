#!/usr/bin/env ruby

begin
  require 'rubygems'
rescue LoadError
end

require 'midwife'
require 'optparse'
require 'ostruct'

options = OpenStruct.new
options.config = "/etc/midwife/config.rb"
options.command = :start

OptionParser.new do |opts|
  opts.banner = "Usage: midwife [options]"

  opts.on("-c", "--config FILE", "Read configuration from the specified file") do |config|
    options.config = config
  end

  opts.on("--start", "Start the server (default)") do
    options.command = :start
  end

  opts.on("--stop", "Stop the server") do
    options.command = :stop
  end

  opts.on("--restart", "Restart the server") do
    options.command = :restart
  end
end.parse!

# Read in the configuration
Midwife.configure do |config|
  config.from_file(options.config)
end

case options.command
when :start
  Midwife::Server::Control.start
when :stop
  Midwife::Server::Control.stop
when :restart
  Midwife::Server::Control.restart
end